<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="icon" href="img/favicon.ico" />
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="Ce site fournit des statistiques sur les vélos et stations en location par la métropole Aix-Marseille">
  <meta name="keywords" content="Marseille, métropole, levélo, levelo, vélo">

  <title class="i18n" i18n="title">Statistiques du service "levélo Marseille"</title>
  <style>
    html {
      font-family: sans-serif;
    }

    h1 {
      font-size: 120%;
    }

    h2 {
      font-size: 110%;
      border-top: 1px solid black;
      padding-top: 10px;
    }
    .scope-div {
      text-align: center;
      width: 100%;
    }

    .chart {
      width: 100%;
      height:400px;
      margin: 10px;
      display: inline-block;
      vertical-align: middle;
      border-spacing: 10px
    }

    footer {
      padding-top: 10px;
      font-style: italic;
      font-size: 80%;
      color: slategray;
      text-align: right;
    }

    a {
      text-decoration: none;
      color: rgb(86, 139, 192);
    }

    #month-next,
    #days-reset {
      margin-right: 20px;
    }

    .status {
      display: inline-block;
      margin: 100px;
    }
  </style>
</head>

<body>
  <h1 class="i18n" i18n="title">Statistiques du service "levélo Marseille"</h1>
  <p><span class="i18n" i18n="info-intro">Informations collectées depuis les </span>
    <a class="i18n" i18n="info-data"
      href="https://data.ampmetropole.fr/explore/dataset/gbfs-donnees-gbfs-levelo-a-marseille/table/?q=">
      données publiques de la métropole Aix-Marseille</a>
  </p>

  <div class="scope-div">
    <span class="i18n" i18n="scope">Période :</span>
    <label>
      <input type="radio" name="scope" value="year" checked="checked">
      <span class="i18n" i18n="last-year">12 derniers mois</span>
    </label>
    <label>
      <input type="radio" name="scope" value="all">
      <span class="i18n" i18n="all-times">Depuis le début</span>
    </label>
  </div>
  <div id="content">
      <div id="bikes-chart" class="chart"></div>
      <div id="stations-chart" class="chart"></div>
  </div>
  <footer>
    <span class="i18n" i18n="footer">
      Ce site n'est pas affilié au service "levélo". Les données ne sont pas garanties exactes.
    </span>
    <a href="https://github.com/opoto/stats-levelo" class="i18n" i18n="code">Code source</a>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/cash-dom/dist/cash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js" integrity="sha512-k37wQcV4v2h6jgYf5IUz1MoSKPpDs630XGSmCaCCOXxy2awgAWKHGZWr9nMyGgk3IOxA1NxdkN8r1JHgkUtMoQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>

    const i18n = {
      default: "fr",
      current: navigator.language.substring(0, 2),
      strings: {
        "fr": {
          "bikes": "Vélos",
          "date": "Date",
          "loading": "Chargement en cours...",
          "bikes_nb": "Nombre de vélos",
          "for_rent": "A louer",
          "disabled": "Hors-service",
          "reserved": "Réservés",
          "no_station": "Hors station",
          "stations": "Stations",
          "stations_nb": "Nombre de stations",
          "ready": "En service",
          "renting": "Avec vélo disponible",
          "returning": "Avec dock libre",
          "not_installed": "Hors-service",
          "not_renting": "Pas de location",
          "not_returning": "Pas de retour",
          "no_data": "Pas de données au delà !",
          "load_error": "Erreur de chargement des données"
        },
        "en": {
          "title": 'Statistics about "levélo Marseille"',
          "info-intro": "Data is collected from",
          "info-data": "métropole Aix-Marseille's open data",
          "scope": "Considered period:",
          "last-year": "12 last months",
          "all-times": "All times",
          "loading": "Loading...",
          "footer": 'This site is independent from "levélo". Content is not guaranteed to be exact.',
          "code": "Source code",
          "bikes": "Bikes",
          "date": "Date",
          "bikes_nb": "Number of bikes",
          "for_rent": "To rent",
          "disabled": "Disabled",
          "reserved": "Reserved",
          "no_station": "Not in station",
          "stations": "Stations",
          "stations_nb": "Number of stations",
          "ready": "Ready",
          "renting": "With available bike",
          "returning": "With available dock",
          "not_installed": "Not installed",
          "not_renting": "Not renting",
          "not_returning": "Not returning",
          "no_data": "No data for this period!",
          "load_error": "Error while loading data"
        }
      },
      get: (name, params) => {
        let v = i18n.strings[i18n.current][name];
        return v ? v : i18n.strings[i18n.default][name];
      }
    };
    $(".i18n").each((i, elt) => {
      let key = elt.getAttribute("i18n");
      let translated = key ? i18n.get(key) : undefined;
      if (translated) {
        elt.innerText = translated;
      }
    });

    function displaySeries(type, series, colors, domElement) {
      if (--loading <= 0) {
        setStatus(domElement);
      }

      const WEEK = 24*7;
      const eChartOptions = {
        title: {
          left: 100,
          text: i18n.get(type)
        },
        tooltip: {
          trigger: 'axis'
        },
        legend: {
          top: 25
        },
        xAxis: {
          type: 'time',
        },
        color: colors,
        dataZoom: [
          {
            type: "slider",
            realtime: true,
            minSpan: 3,
            start: 66,
            end: 100
          }
        ],
        toolbox: {
          feature: {
            dataZoom: {
              yAxisIndex: 'none'
            },
            restore: {},
            saveAsImage: {}
          }
        },
        yAxis: {
        },
        series: series
      };

      console.debug(eChartOptions);
      // Initialize the echarts instance based on the prepared dom

      let myChart = echarts.getInstanceByDom(domElement);
      if (myChart) {
        myChart.dispose();
      }
      myChart = echarts.init(domElement);
      // Display the chart using the configuration items and data just specified.
      myChart.setOption(eChartOptions);
    }

    const CONFIG = {
      "bikes": {
        chart: "bikes-chart",
        lines: [
          {
            name: "bikes_nb",
            index: 1,
            color: "blue"
          },
          {
            name: "for_rent",
            index: 2,
            color: "green"
          },
          {
            name: "no_station",
            index: 5,
            color: "red"
          }
        ]
      },
      "stations": {
        chart: "stations-chart",
        lines: [
          {
            name: "stations_nb",
            index: 1,
            color: "blue"
          },
          {
            name: "renting",
            index: 3,
            color: "green"
          },
          {
            name: "returning",
            index: 4,
            color: "purple"
          }
        ]
      }
    };

    async function load(dates) {
      for (type of ["bikes", "stations"]) {
        try {

          const domChart = document.getElementById(CONFIG[type].chart);
          setStatus(domChart, "loading");
          let series, colors = [];

          // for each date
          for (let date of dates) {

            const response = await fetch(`data/${date}_${type}.csv`);
            const data = await response.text();
            // Extract CSV data
            let lines = data.split('\n');
            for (let line of lines) {
              if (!line.trim()) continue;
              const values = line.split(',');
              if (typeof (series) == "undefined") {
                // header line, extract field names
                series = [];
                for (let seriesLine of CONFIG[type].lines) {
                  series.push({
                    name: i18n.get(values[seriesLine.index]),
                    type: 'line',
                    symbolSize: 0,
                    data: []
                  });
                  colors.push(seriesLine.color);
                }
              } else if (line.startsWith("date") || line.startsWith("null")) {
                // ignore header or error lines
              } else {
                // data line, starting by date
                const intDate = Number.parseInt(values[0]);
                const dateSample = !isNaN(intDate) && new Date(1000 * intDate);
                // only process lines with valid date
                if (dateSample) {
                  let i = 0;
                  for (let seriesLine of CONFIG[type].lines) {
                    const vSample = Number.parseInt(values[seriesLine.index]);
                    // only add valid values
                    if (!isNaN(vSample)) {
                      series[i++].data.push([dateSample, vSample]);
                    }
                  }
                }
              }
            }
          }

          displaySeries(type, series, colors, domChart);
        } catch (err) {
          console.error(err);
          setStatus(domType, "load_error");
        }
      }
    }

    const NOW = new Date();

    let loading = 2;
    function setStatus(domElement, messageId) {
      domElement.innerHTML = messageId ?
       `<div class='status'>${i18n.get(messageId)}</div>`
       : "";
    }

    function loadFromScope() {
      $(".chart").empty();
      const twoDigitsMonth = (month) => ("0" + (month + 1)).slice(-2);
      let dates = [];
      if ($("input[name=scope]:checked").val() == "year") {

        // last 12 months
        const current = NOW.getFullYear().toString() + "-" + twoDigitsMonth(NOW.getMonth());
        let year = NOW.getFullYear() - 1;
        let month = NOW.getMonth();
        while (true) {
          month = (month + 1) % 12;
          if (month == 0) {
            year++;
          }
          const date = year.toString() + "-" + twoDigitsMonth(month);
          dates.push(date);
          if (date == current) {
            break;
          }
        }

      } else {

        // all times
        const currentYear = NOW.getFullYear();
        let year = 2023;
        while (true) {
          dates.push(year.toString());
          year++;
          if (year > currentYear) {
            break;
          }
        }

      }

      // do the loading!
      console.debug(dates);
      load(dates);
    }

    $("input[name=scope]").on("change", loadFromScope);
    loadFromScope();

  </script>
</body>

</html>